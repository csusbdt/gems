<html>

<head>
  <!--[if lt IE 8]>
    <meta http-equiv="refresh" content="0;URL=http://theie7countdown.com/">
  <![endif]-->
  <meta charset="UTF-8">
  <title>App 405</title>
  <style>
    #message-dialog, 
    #login-screen, 
    #menu-screen, 
    #loading-screen {
      display: none
    }
    #message-dialog {
      position: absolute;
      left: 20px;
      top: 20px;
      z-order: 1;
      background-color: yellow;
      padding: 30px;
    }
  </style>

</head>

<body>

<div id="message-dialog"><span id="message-text"></span> <button id="message-dismiss-btn">Dismiss</button></div>

<div id="loading-screen">
  Loading ...
</div>

<div id="login-screen">
  Username: <input id="login-username-box" type="text" size="20" /> <br>
  Password: <input id="login-password-box" type="password" size="20" /> <br>
  <button id="login-btn">Login</button>
</div>

<div id="menu-screen">
  <div>Balance: <span id="menu-balance-text">?</span></div>
  <div>Gems: <span id="menu-gems-text">?</span></div>
  <button id="menu-buy-gem-btn">Buy gem</button>
  <button id="menu-logout-btn">Logout</button>
</div>

<!-- boilerplate code that can be used in other projects -->
<script>
var app = {}; // global object to hold all application data and logic

// The following code schedules app.init to be called
// after initialization of the DOM. This code works in
// ie 8 and later (and maybe earlier than ie 7 as well).
(function() {
  if (window.onload) {
    var originalOnload = window.onload;
    window.onload = function() {
      originalOnload();
      app.init();
    };
  } else {
    window.onload = function() {
      app.init(); 
    }
  }
})();

app.createHttpRequest = function() {
  if (window.XMLHttpRequest) {
    return new XMLHttpRequest(); 
  } else if (window.ActiveXObject) {
    try {
      return new ActiveXObject("Msxml2.XMLHTTP");
    } catch (e) {
      try {
        return new ActiveXObject("Microsoft.XMLHTTP");
      } catch (e) {
        alert('This page will not function correctly; try another browser.');
      }
    }
  }
};

app.ajax = function(url, reqData, cb) {
  var request = app.createHttpRequest();
  request.onreadystatechange = function() {
    if (request.readyState !== 4) return;
    if (request.status !== 200) {
      console.log('There was a problem with the request.');
      return cb(new Error(request.status));
    }
    var resData = JSON.parse(request.responseText);
    cb(null, resData);
  };
  request.open('POST', url);
  request.send(JSON.stringify(reqData));
};
</script>

<!-- app state caching through localStorage -->
<script>
app.readLocalStorage = function() {
  app.doc = JSON.parse(localStorage.getItem('doc'));
  if (app.doc) {
    app.username = app.doc._id;
    app.password = app.doc.pw;
  }
};

app.writeLocalStorage = function() {
  if (app.doc) {
    localStorage.setItem('doc', JSON.stringify(app.doc)); 
  } else {
    localStorage.removeItem('doc');
  }
};
</script>

<!-- messages to user -->
<script>
app.displayMessageDialog = function(message) {
  document.getElementById("message-dialog").style.display = 'block';
  document.getElementById("message-text").innerHTML = message;
  document.getElementById("message-dismiss-btn").focus();
};

app.dismissMessage = function() {
  document.getElementById("message-dialog").style.display = 'none';
};
</script>

<!-- screen transition -->
<script>
app.setScreen = function(id) {
  if (app.screen === id) return;
  if (app.screen) {
    document.getElementById(app.screen).style.display = 'none';
  }
  document.getElementById(id).style.display = 'block';
  app.screen = id;
};
</script>

<!-- login screen -->
<script>
app.displayLoginScreen = function() {
  document.getElementById('login-username-box').value = app.username
  document.getElementById('login-password-box').value = app.password;
  app.setScreen('login-screen');
};

app.login = function() {
  if (app.screen !== 'login-screen') return alert('ERROR: not in login screen.');
  app.username = document.getElementById('login-username-box').value;
  app.password = document.getElementById('login-password-box').value;
  app.setScreen('loading-screen');
  app.ajax('get-doc', { _id: app.username, pw: app.password }, function(err, resData) {
    if (err) {
      app.displayMessageDialog('error');
      app.displayLoginScreen();
    } else if (resData.error) {
      app.displayMessageDialog(resData.error);
      app.displayLoginScreen();
    } else if (resData.login) {
      app.displayMessageDialog('Invalid username or password.');
      app.displayLoginScreen();
    } else {
      app.doc = resData.doc;
      app.writeLocalStorage();
      app.displayMenuScreen();
    }
  });
};
</script>

<!-- menu screen -->
<script>
app.displayMenuScreen = function() {
  document.getElementById("menu-balance-text").innerHTML = app.doc.balance;
  document.getElementById("menu-gems-text").innerHTML = app.doc.gems;
  app.setScreen('menu-screen');
};

app.buyGem = function() {
  if (app.screen !== 'menu-screen') return alert('ERROR: not in menu screen.');
  app.setScreen('loading-screen');
  app.ajax('buy-gem', {_id: app.doc._id, _rev: app.doc._rev, pw: app.doc.pw}, function(err, resData) {
    if (err) {
      app.displayMessageDialog('error');
      app.displayMenuScreen();
    } else if (resData.error) {
      app.displayMessageDialog(resData.error);
      app.displayMenuScreen();
    } else if (resData.login) {
      app.displayLoginScreen();
    } else if (resData.old) {
      app.doc = resData.doc;
      app.writeLocalStorage();
      app.displayMessageDialog('Please try again.');
      app.displayMenuScreen();
    } else if (resData.insufficientBalance) {
      app.displayMessageDialog('Insufficient balance.');
      app.displayMenuScreen();
    } else {
      app.doc = resData.doc;
      app.writeLocalStorage();
      app.displayMessageDialog('Gem purchased.');
      app.displayMenuScreen();
    }
  });
};
</script>

<!-- logout -->
<script>
app.logout = function() {
  app.username = '';
  app.password = '';
  delete app.doc;
  app.writeLocalStorage();
  app.displayLoginScreen();
};
</script>

<!-- app init -->
<script>
app.init = function() {
  // Register button click handlers.
  document.getElementById('message-dismiss-btn').onclick = app.dismissMessage;
  document.getElementById('menu-buy-gem-btn').onclick = app.buyGem;
  document.getElementById('login-btn').onclick = app.login;
  document.getElementById('menu-logout-btn').onclick = app.logout;

  app.readLocalStorage();
  app.setScreen('login-screen');
  if (app.username) {
    document.getElementById('login-username-box').value = app.username;
    document.getElementById('login-password-box').value = app.password;
    app.login();
  }
};
</script>

</body>

</html>

