<html>

<head>
  <!--[if lt IE 8]>
    <meta http-equiv="refresh" content="0;URL=http://theie7countdown.com/">
  <![endif]-->
  <meta charset="UTF-8">
  <title>App 405</title>
  <style>
    #message-dialog, 
    #login-screen, 
    #menu-screen, 
    #loading-screen {
      display: none
    }
    #message-dialog {
      position: absolute;
      left: 20px;
      top: 20px;
      z-order: 1;
      background-color: yellow;
      padding: 30px;
    }
  </style>

</head>

<body>

<div id="message-dialog"><span id="message-text"></span> <button id="message-dismiss-btn">Dismiss</button></div>

<div id="loading-screen">
  Loading ...
</div>

<div id="login-screen">
  Username: <input id="login-username-box" type="text" size="20" /> <br>
  Password: <input id="login-password-box" type="password" size="20" /> <br>
  <button id="login-submit-btn">Login</button>
</div>

<div id="menu-screen">
  <div>Balance: <span id="menu-balance-text">?</span></div>
  <div>Gems: <span id="menu-gems-text">?</span></div>
  <button id="menu-buy-gem-btn">Buy gem</button>
  <button id="menu-logout-btn">Logout</button>
</div>

<!-- boilerplate code that can be used in other projects -->
<script>
var app = { screens: {} }; // global object to hold all application data and logic

// The following code schedules app.init to be called
// after initialization of the DOM. 
(function() {
  if (window.onload) {
    var originalOnload = window.onload;
    window.onload = function() {
      originalOnload();
      app.init();
    };
  } else {
    window.onload = function() {
      app.init(); 
    }
  }
})();

app.createHttpRequest = function() {
  if (window.XMLHttpRequest) {
    return new XMLHttpRequest(); 
  } else if (window.ActiveXObject) {
    try {
      return new ActiveXObject("Msxml2.XMLHTTP");
    } catch (e) {
      try {
        return new ActiveXObject("Microsoft.XMLHTTP");
      } catch (e) {
        alert('This page will not function correctly; try another browser.');
      }
    }
  }
};

app.ajax = function(url, reqData, cb) {
  var request = app.createHttpRequest();
  request.onreadystatechange = function() {
    if (request.readyState !== 4) return;
    if (request.status !== 200) {
      console.log('There was a problem with the request.');
      return cb(new Error(request.status));
    }
    var resData = JSON.parse(request.responseText);
    cb(null, resData);
  };
  request.open('POST', url);
  request.send(JSON.stringify(reqData));
};
</script>

<!-- app state caching through localStorage -->
<script>
app.readLocalStorage = function() {
  app.doc = JSON.parse(localStorage.getItem('doc'));
  if (app.doc) {
    app.username = app.doc._id;
    app.password = app.doc.pw;
  }
};

app.writeLocalStorage = function() {
  if (app.doc) {
    localStorage.setItem('doc', JSON.stringify(app.doc)); 
  } else {
    localStorage.removeItem('doc');
  }
};
</script>

<!-- messages to user -->
<script>
app.displayMessageDialog = function(message) {
  document.getElementById("message-dialog").style.display = 'block';
  document.getElementById("message-text").innerHTML = message;
  document.getElementById("message-dismiss-btn").focus();
};

app.dismissMessage = function() {
  document.getElementById("message-dialog").style.display = 'none';
};
</script>

<!-- Screen constructor -->
<script>
app.Screen = function(name) {
  this.name = name;
  this.div = document.getElementById(name + '-screen');
};

app.Screen.prototype.show = function() {
  if (app.currentScreen) app.currentScreen.div.style.display = 'none';
  this.div.style.display = 'block';
  app.currentScreen = this;
};
</script>

<!-- app.init -->
<script>
app.init = function() {
  // initialize dialog
  document.getElementById('message-dismiss-btn').onclick = app.dismissMessage;

  // loading screen
  app.screens.loading = new app.Screen('loading');

  app.screens.loading.activate = function() {
    app.screens.loading.show();
  };

  // login screen
  app.screens.login = new app.Screen('login');

  app.screens.login.usernameBox = document.getElementById('login-username-box');
  app.screens.login.passwordBox = document.getElementById('login-password-box');
  app.screens.login.submitButton = document.getElementById('login-submit-btn');

  app.screens.login.activate = function() {
    if (app.username !== undefined) {
      app.screens.login.usernameBox.value = app.username;
      app.screens.login.passwordBox.value = app.password;
    }
    app.screens.login.show();
  };

  app.screens.login.submitButton.onclick = function() {
    app.screens.loading.activate();
    app.username = app.screens.login.usernameBox.value;
    app.password = app.screens.login.passwordBox.value;
    app.ajax('get-doc', { _id: app.username, pw: app.password }, function(err, resData) {
      if (err) {
        app.screens.login.activate();
        app.displayMessageDialog('error');
      } else if (resData.error) {
        app.screens.login.activate();
        app.displayMessageDialog(resData.error);
      } else if (resData.login) {
        app.screens.login.activate();
        app.displayMessageDialog('Invalid username or password.');
      } else {
        app.doc = resData.doc;
        app.writeLocalStorage();
        app.screens.menu.activate();
      }
    });
  };

  // menu screen
  app.screens.menu = new app.Screen('menu');

  app.screens.menu.balanceText = document.getElementById('menu-balance-text');
  app.screens.menu.gemsText = document.getElementById('menu-gems-text');
  app.screens.menu.buyGemButton = document.getElementById('menu-buy-gem-btn');
  app.screens.menu.logoutButton = document.getElementById('menu-logout-btn');

  app.screens.menu.activate = function() {
    app.screens.menu.balanceText.innerHTML = app.doc.balance;
    app.screens.menu.gemsText.innerHTML = app.doc.gems;
    app.screens.menu.show();
  };

  app.screens.menu.buyGemButton.onclick = function() {
    app.screens.loading.activate();
    app.ajax('buy-gem', {_id: app.doc._id, _rev: app.doc._rev, pw: app.doc.pw}, function(err, resData) {
      if (err) {
        app.screens.menu.activate();
        app.displayMessageDialog('error');
      } else if (resData.error) {
        app.screens.menu.activate();
        app.displayMessageDialog(resData.error);
      } else if (resData.login) {
        app.screens.login.activate();
      } else if (resData.old) {
        app.doc = resData.doc;
        app.writeLocalStorage();
        app.screens.menu.activate();
        app.displayMessageDialog('Please try again.');
      } else if (resData.insufficientBalance) {
        app.screens.menu.activate();
        app.displayMessageDialog('Insufficient balance.');
      } else {
        app.doc = resData.doc;
        app.writeLocalStorage();
        app.screens.menu.activate();
        app.displayMessageDialog('Gem purchased.');
      }
    });
  };

  app.screens.menu.logoutButton.onclick = function() {
    app.username = '';
    app.password = '';
    delete app.doc;
    app.writeLocalStorage();
    app.screens.login.activate();
  };

  app.readLocalStorage();
  if (app.username) {
    app.screens.login.activate();
    app.screens.login.submitButton.click();
  } else {
    app.screens.login.activate();
  }
};
</script>

</body>

</html>

